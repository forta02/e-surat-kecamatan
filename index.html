if (localStorage.getItem("loggedIn") !== "true") {
  window.location.href = "index.html";
}

function logout() {
  localStorage.removeItem("loggedIn");
  window.location.href = "index.html";
}

function showForm(type) {
  const formContainer = document.getElementById("form-container");
  const tableContainer = document.getElementById("table-container");
  let html = `
    <form id="dataForm" onsubmit="saveData(event,'${type}')">
      <input type="text" id="nomor" placeholder="Nomor" required>
      <input type="text" id="nomorSurat" placeholder="Nomor Surat" required>
      <input type="date" id="tanggalSurat" required>
      <input type="text" id="hal" placeholder="Hal" required>`;

  if (type === "masuk") {
    html += `
      <input type="date" id="tanggalDiterima" required>
      <input type="text" id="asalSurat" placeholder="Asal Surat" required>`;
  } else {
    html += `<input type="text" id="tujuanSurat" placeholder="Tujuan Surat" required>`;
  }

  html += `<button type="submit">Simpan</button></form>`;
  formContainer.innerHTML = html;

  renderTable(type);
}

function getData(type) {
  return JSON.parse(localStorage.getItem("data_" + type)) || [];
}

function saveData(event, type) {
  event.preventDefault();
  const data = getData(type);
  const entry = {
    nomor: document.getElementById("nomor").value,
    nomorSurat: document.getElementById("nomorSurat").value,
    tanggalSurat: document.getElementById("tanggalSurat").value,
    hal: document.getElementById("hal").value,
  };
  if (type === "masuk") {
    entry.tanggalDiterima = document.getElementById("tanggalDiterima").value;
    entry.asalSurat = document.getElementById("asalSurat").value;
  } else {
    entry.tujuanSurat = document.getElementById("tujuanSurat").value;
  }

  data.push(entry);
  localStorage.setItem("data_" + type, JSON.stringify(data));
  renderTable(type);
  document.getElementById("dataForm").reset();
}

function renderTable(type) {
  const data = getData(type);
  const tableContainer = document.getElementById("table-container");
  if (data.length === 0) {
    tableContainer.innerHTML = "<p>Belum ada data.</p>";
    return;
  }

  let table = `<table><thead><tr>
    <th>Nomor</th>
    <th>Nomor Surat</th>
    <th>Tanggal Surat</th>
    <th>Hal</th>`;

  if (type === "masuk") {
    table += `<th>Tanggal Diterima</th><th>Asal Surat</th>`;
  } else {
    table += `<th>Tujuan Surat</th>`;
  }

  table += `</tr></thead><tbody>`;
  data.forEach((d) => {
    table += `<tr>
      <td>${d.nomor}</td>
      <td>${d.nomorSurat}</td>
      <td>${d.tanggalSurat}</td>
      <td>${d.hal}</td>`;
    if (type === "masuk") {
      table += `<td>${d.tanggalDiterima}</td><td>${d.asalSurat}</td>`;
    } else {
      table += `<td>${d.tujuanSurat}</td>`;
    }
    table += `</tr>`;
  });
  table += `</tbody></table>
    <button class="download-btn" onclick="downloadPDF('${type}')">Download PDF</button>`;

  tableContainer.innerHTML = table;
}

async function downloadPDF(type) {
  const { jsPDF } = window.jspdf;
  const element = document.getElementById("table-container");
  const canvas = await html2canvas(element);
  const imgData = canvas.toDataURL("image/png");
  const pdf = new jsPDF("p", "pt", "a4");
  const imgWidth = 550;
  const pageHeight = 780;
  const imgHeight = (canvas.height * imgWidth) / canvas.width;
  let heightLeft = imgHeight;
  let position = 20;

  pdf.addImage(imgData, "PNG", 25, position, imgWidth, imgHeight);
  heightLeft -= pageHeight;
  while (heightLeft >= 0) {
    position = heightLeft - imgHeight;
    pdf.addPage();
    pdf.addImage(imgData, "PNG", 25, position, imgWidth, imgHeight);
    heightLeft -= pageHeight;
  }

  const fileName = type === "masuk" ? "surat_masuk.pdf" : "surat_keluar.pdf";
  pdf.save(fileName);
}
